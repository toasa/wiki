https://www.amazon.co.jp/Computer-Networks-Global-Andrew-Tanenbaum/dp/1292374063

# 1. Introduction

## 1.4 ネットワークの例

### 1.4.3 無線ネットワーク (WiFi)

WiFi (正式には 802.11) は ISM (Industrial, Scientific, and Medical) 帯（例えば 2.4 GHz, 5 GHz。これらの周波数帯は免許不要）で動作する。


## 1.6 Reference Models

モデルは各レイヤから成る。各レイヤの実装としてプロトコルがある。
例えば、TCP/IP reference モデルは Application, Transport, Internet, Link レイヤから成る。
例えば、Transport レイヤのプロトコルとして TCP, UDP がある。

### 1.6.3

OSI モデルが流行らなかった原因は Timing, Desing, Implementation, Politics が悪かった。

- Timing の悪さ。仕様が受け入れられるにはタイミングが重要。アカデミックな研究は成熟したが、市場の製品としては出回っていないタイミング（いわゆる "Apocalypse of the two elephants" の象の間のタイミング）が望ましい。OSIモデルが現れた頃は、すでに TCP/IP が広く使われていた。
- Design の悪さ。綺麗にレイヤが分かれていない。セッション層とプレゼンテーション層はほぼ空で、データリンク層とネットワーク層は大き過ぎる。別の問題点として、同じような機能が異なるレイヤで重複して定義されている。
- Implementation の悪さ。モデル、プロトコルの悪さから実装も巨大に。"Everyone who tried them got burned"。その後時間とともに実装は良くなったが、"Once people think something is bad, its goose is cooked."。
- Polictics の悪さ。

### 1.6.5

OSI モデルの強みはモデルそのもの（ただし Presentaion レイヤと Session レイヤは除く）。
TCP/IP モデルの強みはプロトコルが広く使われていること。
なので本書では両者の良いとこどりをした新たなモデルを使う。
モデルは、下から Physical, Link, Network, Transport, Application レイヤから成る。

## 1.7

De facto standard と対になる De jure standard という用語を知る。
意味は De facto の反対。つまり公的に標準化された規格のこと。

### 1.8.3

フィッシングサイトのフィッシング、Fishing と思っていたが、Phishing らしい。
語源は諸説あるらしい：https://ja.wikipedia.org/wiki/%E3%83%95%E3%82%A3%E3%83%83%E3%82%B7%E3%83%B3%E3%82%B0_(%E8%A9%90%E6%AC%BA)#%E8%AA%9E%E6%BA%90

### 1.8.4

Browser fingerprinting を知らなかったので以下のサイトで学ぶ：

https://www.saitolab.org/fp_site/

> Webサイト管理者はアクセスしてきた利用者のブラウザの種類、画面解像度、プラグインの名前やインストール済みフォントの一覧などを取得することができます。これらの情報は利用者ごとに微妙に異なるので、利用者を識別するための特徴点となります。 1つの特徴点だけに注目した場合、同じブラウザや同じ画面解像度を利用している人が複数存在するので利用者の識別は難しいですが、複数の特徴点を組み合わせた場合、すべての特徴点が一致することは稀なので利用者の識別に利用できるとされています。このように利用者の識別につながる特徴点の集合をFingerprintと呼びます。

## 1.10

各章の Overview。
3章のBluetooth, 7章の email のプロトコル、CDN サービスが興味ある

# 2. 物理層

## 2.1 有線伝送媒体

### 2.1.5 光ファイバ

光ファイバの物理的特性からくる転送レートの限界は50Tbps。
現在の光ファイバは 100Gbps ほどで、そのボトルネックは電気と光の変換のところにある。
CPUのクロック周波数が物理的限界に近づいていることとは対称的。
[APN](https://www.rd.ntt/iown/0002.html) だな、将来は。

光ファイバはガラスからできている。
普通のガラスではなく、とても透明性が高いガラス。
もし海の水が光ファイバのガラスに置き換わった場合は、海面から海底が見えるほど。すごいなw

## 2.2 無線伝送

### 2.2.1 電磁スペクトル

真空中では、すべての電磁波は周波数にかかわらず光速で進む。

電磁スペクトル。ある時点で特定のバンド幅に {Low,Middle,High} Frequency と名付けてしまったため、
後年それ以上の高周波数帯が必要になると接頭辞 Very, Ultra, Super, Extremely, Tremendously をつけて対応した経緯がある。
名前づけミスってるw。

周波数と信号対雑音比から転送速度を求める方法。30000GHz, 10dB で 300Tbps とあるが、計算式がわからない。そもそもデシベルがわかってない。

## 2.3 スペクトルを用いた伝送

### 2.3.1 無線伝送

波のおさらい。
低い周波数帯は、無指向性、地表の湾曲に沿う。
高い周波数帯（100MHz以降）は、指向性あり、直線上に進む。
鉄塔が遠く離れすぎていると、地球が間に入る。そのため中継機が必要になる。
まとめ：

||高周波|低周波|
|---|---|---|
|波の減衰<br>（振幅低下）|大|小|
|伝搬距離|短|長|
|指向性|強|弱|
|波の回析|弱|強|

### 2.3.3 赤外線伝送

指向性あり、固体を通り抜けない。セキュリティ上は利点。免許いらない。

### 2.3.4 光伝送

ディスプレイの光を、人間の知覚閾値を超えて on/off することで、
ディスプレイ周辺に低速のネットワークを作れる。おもしろ。

## 2.4 波形からビットへ

### 2.4.1 データ通信の理論的基礎

フーリエ解析。
任意の周期関数は *sin* と *cos* の級数で表現できますね、というはなし。
途中出てくる式変形がほぼわからない...
*sin^2(x)* の積分方法がわからないのはまだ良いとして（良くない）、
そもそも *sin(x)* の微分すら忘れてた...。
x = 0, π/2, π, の時の *sin(x)* のグラフの傾きを思い描き、
sin の微分が cos と思い出す。
数学を使わず六年経つと、こんなもんですよ...。

周期と波長、混同してた...。
周期は、山から次の山までの時間。
波長は、山から次の山までの距離。

## 2.4.4 多重化

１つのチャネルを共有する方法。

- FDM (Frequency Division Multiplexing)<br>
  周波数スペクトルを周波数帯域に分割し、帯域を排他的に使用する。802.11、4Gセルラー回線で用いられる。
- TDM (Time Division Multiplexing)<br>
  チャネル利用者にラウンドロビンで利用権利（タイムスライス）を割り当てていく。
- CDM (Codee Division Multiplexing)<br>
  スペクトル拡散（狭い周波数帯域で表現されていた元の信号を、広い周波数帯域に渡って広く薄く分散して送受信する）を使った多重化。干渉に強く、複数の利用者が複数の信号で同じ周波数帯を使える。

## 2.5 公衆電話交換網

### 2.5.2 ローカル・ループ：電話モデム、ADSL、光ファイバ

#### 電話モデム

物理チャネル上を伝送するために、デジタル信号をアナログ信号に変換する必要がある。
デジタル信号とアナログ信号の変換器をモデム (Modem) という。
名前の由来は変調器復調器 (Modulator demodulator) の短縮。

## 2.6 セルラー・ネットワーク

### 2.6.1 共通概念：セル、ハンドオフ、ページング

全ての携帯電話システムにおいて、地域的区域は**セル (Cell)** に分割されている。
携帯電話が Cell phone とも呼ばれる所以はそれ。
各セルが使用する周波数帯は、隣接するセルのいずれでも使われていない周波数帯を使う。

セルが小さいほど、システム容量（最大データ転送速度のこと？ 2.4.2 参照）を増やせる。
スポーツイベントや音楽フェスなど多数のユーザが局所的に集まる場合、
セルを臨時的により細かいセル（マイクロセル）に分割することがある。
これにより、より多くの周波数が再利用でき、負荷分散となる。
かっこいい。

携帯電話がセルをまたがって移動すると、セルの切り替えが行われる。
この過程を**ハンドオフ (Handoff)** という。

# 3. データ・リンク層

## 3.1 データ・リンク層の設計課題

### 3.1.1 ネットワーク層に対して提供されるサービス

データリンク層のプロトコルで提供されるサービスの特性として、
Ack の有無、Connection の有無が考えられる。

Ack が有る場合、個々のフレーム単位でパケロスに対処できる
（フレーム単位の再送ができる）。
一方 Ack が無い場合、 ネットワーク層など上位レイヤにパケロス回復を委ねる他ない。
例えば、ネットワーク層の1パケットが、データリンク層で10フレームに分割され、
そのうち平均2フレームがパケロスする場合、再送されるフレーム数は Ack の有無で5倍違う。

Connection がある場合、送信側で送る各フレームには番号が付けられる。
受信側では、各フレームが、一度だけ、正しい順序で受信されることを保証する。
Connection は、長く信頼性が低い回線で有効。

まとめ：

|サービス種別|例|
|---|---|
|Ack 無し、Connectionless|Ethernet|
|Ack 有り、Connectionless|802.11 (WiFi)|
|Ack 有り、Connection-oriented|衛星チャネル、長距離電話回線|

### 3.1.2 フレーム化

ビット・ストリームをフレームに分割することは、
任意のビットが変わりうるため、想像ほど簡単ではない。

### 3.1.3 誤り制御

### 3.1.4 フロー制御

## 3.2 誤り検出および訂正

通信チャネルによって、伝送誤りが高いもの（e.g. 無線リンク）もあれば、
誤りが低いもの（e.g. 光ファイバ）もある。
伝送誤りの発生頻度に差はあれど、避けることはできない。
そのため、誤りに対処する必要があり、その戦略は２つある：

1. 誤り訂正符号
1. 誤り検出符号

どちらもデータに冗長な情報を付け加える。
誤り訂正の場合、冗長な情報から、受信側が送信データを復元できる ("be able to deduce what the transmitted data must have been.") ようにする戦略。
誤り検出の場合、冗長な情報から、受信側が誤りの発生に気づく（ただし、どんな誤りかはわからない）戦略。

## 3.4 効率の改善

### 3.4.1 目標：両方向伝送、確認通知前に複数フレームを送信

両方向伝送の場合の伝送工率の改善。
A から B にデータを送ったとする。B は直ちに Ack を返すのではなく、
B から A にデータ転送する際に、フレーム内ヘッダに Ack を含めて A に送る。
この技法を**ピギーバック (Piggybacking)** という。

# 4. 媒体アクセス制御副層

複数の局 (stattion) が１つのチャネルを使ってデータ転送する場合がある。
このようなチャネルを、ブロードキャスト・チャネル（多重アクセスチャネル、ランダムアクセス・チャネルとも）と呼ぶ。
ブロードキャスト・チャネルの場合、
次にどの局がチャネルを利用してよいか決める必要がある。
MAC (Media Access Control) 副層でそれを決めるプロトコルが規定されている。
MAC副層はデータ・リンク層の最下層に位置する。

## 4.2 多重アクセス・プロトコル

### 4.2.3 衝突のないプロトコル

トークン・バスプロトコル。各局はトークン、またはフレームを受信する局と送信する局を持ち、局全体で論理的なリングをなす。
送信する方向は一方向。トークンを持っている局がフレームを投げる権利がある。
投げる必要がない場合、次の局にトークンを投げ渡す。
教科書では「あまりにひどいため、IEEEが取り下げた規格」と解説されている。
どのあたりがまずかったんだろ？

## 4.3 イーサネット

## 4.4 無線LAN

### 4.4.1 802.11 のアーキテクチャとプロトコル・スタック

802.11a の仕様は1999年に決まった。今もよく使っているが、20年以上前の仕様だったとは。

## 4.5 BLUETOOTH

標準化団体の名前 Special Interest Group (SIG) って名前が面白いｗ。

### 4.5.4 Bluetooth の無線通信層

Bluetooth は 2.4 GHz の ISM 帯を使う。

# 5. ネットワーク層

## 5.3 ネットワーク層でのトラフィック管理

### 5.3.1 トラフィック管理の必要性：輻輳

ルータが無限のメモリを持つと、輻輳は悪化するらしい。直感に反する。
パケットを溜め込みすぎることによって、ジッタも増え、適切な輻輳制御が効かなくなる。この問題は Bufferbloat として知られている：

https://ja.wikipedia.org/wiki/Bufferbloat

輻輳制御とフロー制御の違い。輻輳制御は全てのホストとルータに関係する。
一方フロー制御は、特定の送信者と受信者間のトラフィックに関係し、
送信者が受信者の処理できる速度よりも速くデータを送信しないようにする。

### 5.3.2 トラフィック管理の取り組み

負荷遮断 (Load shedding)。ルータに処理可能な量を超えたパケットが届いた場合、
ルータがパケットの一部を破棄する。
破棄するポリシーはさまざま。
古いパケットを優先するポリシーをワイン (Wine) といい、
新しいパケットを優先するポリシーをミルク (Milk) という。

## 5.7 インターネットにおけるネットワーク層

### 5.7.1 IPv4

IP ヘッダの各フィールドの解説。
ヘッダは20Bの固定長部分と、
0Bから40Bまでの可変長部分からなる。
ヘッダに可変長な部分（本ではIPオプションというフィールド）があるとは知らなかった。
今日では、IP オプションは使用されなくなってるらしい。

IPv4 アドレスの枯渇問題への対処法として NAT が考えられた。
NAT は応急措置的な対応で、IPv6 への移行が完了していれば、そもそも枯渇は起こり得ない。
NAT の内側では、各マシンが個別のプライベートアドレスを持ち、
NAT の外側（インターネット側）では１つのグローバルアドレスを持つ。
NAT の境界には NAT box がある。NAT の仕組みは以下：

1. NAT box を通ってパケットが外へ出て行く時
    1. 送信元のプライベートアドレスをグローバルアドレスに置き換える
    1. 送信元プライベートアドレスと送信元ポート番号の組をバリューとするテーブルのエントリを作成する。そのエントリのキーを 0 ~ 65535 から選び、キーバリューペアを作る。パケットの送信元ポート番号を選んだキーの値に置き換える。
    1. IP, TCP/UDP ヘッダのチェックサムを再計算。
1. 外から NAT box へパケットが届く時
    1. TCP/UDP ヘッダ内の送信元ポート番号を抜き出し、NAT ボックスのキーバリューペアから、バリューを取得する。
    1. パケットの宛先アドレス、宛先ポート番号を置き換える。
    1. IP, TCP/UDP ヘッダのチェックサムを再計算。

NAT はネットワーク層の問題であるにもかかわらず、
思いっきり TCP/UDP のポート番号を覗いているので、解決策として綺麗ではない。

### 5.7.4 インターネット制御プロトコル

ルータを介してホスト１からホスト２へパケットが送られる状況を考える。
ネットワークのレイヤから見ると、送信元IPアドレスと宛先IPアドレスが決まった一本の経路と見做せる。
一方、データリンクレイヤから見ると、（１）ホスト１からルータ、（２）ルータからホスト２、という２本の経路になる。
つまり、送信元MACアドレスと宛先MACアドレスは２本の経路ごとに異なる。
ルータを介することで、IPパケットは変わらないが、Ether のヘッダが変わる。
この辺りが自分はよく忘れる、というメモ。

サブネットの中から外へ送信されるパケットは、通常は **デフォルト・ゲートウェイ (Default gateway)** というルータにいく。
慣例では、ネットワーク内の最小のアドレス（e.g. 192.168.0.0/24 のネットワークなら、192.168.0.1/24） がふられる。

# 6. トランスポート層

## 6.1 トランスポートサービス

### 6.1.1 上位層に提供されるサービス

トランスポート層の仕事を行う SW/HW をトランスポート・エンティティと呼ぶ。
同様にネットワーク層の仕事を行う SW/HW をネットワーク・エンティティと呼ぶ。

## 6.3 輻輳制御

### 6.3.2 送信レートの制御

送信レートの制御は以下の場合が対象：

* フロー制御：受診側のバッファが不十分な場合
* 輻輳制御：経路であるネットワークの容量が不足

## 6.4 UDP

### 6.4.1 UDP入門

UDP の利用例：

* DNS
* RPC (Remote Procedure Call)

## 6.5 TCP

### 6.5.2 TCP サービスモデル

各ソケットは、ホストのIP アドレスとポート番号を持つ。

inetd の動作。各サービスのデーモンを常時起動しておくのではなく、inetd というデーモンのみを起動させておく。
inetd はデーモンの窓口となり、
待受ポートにリクエストが来た場合にのみ、
該当のデーモンを起動する：

https://ja.wikipedia.org/wiki/Inetd

TCP はP2Pのプロトコル。マルチキャスト、ブロードキャストはサポートしない。

TCPコネクションはバイトストリームであり、メッセージストリームではない。
仮に送信プロセスが4つの512Bのセグメントをストリームに転送した場合、
受信プロセスでは512B４つとして受け取るかもしれないし、
2KB １つとして受け取るかもしれない。
つまり、受信側では送信側がどのように転送したかわからない。
これは UNIX のファイルアクセスも同じ特性

### 6.5.8 TCPスライディング・ウィンドウ

セグメントとそれに対する Ack が送られ、
その場合の Sequence number, Acknowledgment number, Window Size の増え方を表した図 6-40 がわかりやすい。

### 6.5.10 TCP輻輳制御

輻輳ウィンドウは送信側、フロー制御ウィンドウは受信側。

# 7. アプリケーション層

## 7.3 WWW

### 7.3.1 アーキテクチャの概要

ブラウザに URL を入力してからページが表示されるまでの流れ：

1. ブラウザが URL に対応する IP アドレスを DNS に問い合わせる
2. DNS が IP アドレスを返す
3. ブラウザはその IP アドレス上のポート 443 (HTTP のデフォルトポート) へ TCP コネクションを張る
4. ブラウザは / の HTTPS リクエストを送信する
5. サーバーは HTTPS レスポンスを返す
6. そのページの表示に必要な URL が含まれている場合、ブラウザは 1 ~ 5 の手順を繰り返す
7. ブラウザがページを画面に表示する
8. TCP コネクションは同じサーバーへのリクエストがしばらくない場合に解放される